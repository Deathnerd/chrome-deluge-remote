<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
  "http://www.w3.org/TR/html4/loose.dtd">
<html>
  <head>
    <script src="js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
      var ENDPOINT = 'http://192.168.0.2:10002/json'
      var INTERVAL_CHECK = 0

      function deluge_status_check() {
        $.post(ENDPOINT,
          JSON.stringify({method: 'auth.check_session', params: [], id: '1'}),
          function(obj, status) {
            // Already logged in? We can do the server check now.
            if(obj && obj['result']) {
              check_connection()
              return
            }
            // Otherwise we need to login.
            console.log('deluge: currently not logged in, trying to login now...')
            login()
          }, 'json')
          
          // Perform the login/connection checks every 5 minutes, just incase.
          if(!INTERVAL_CHECK) {
            INTERVAL_CHECK = setInterval('deluge_status_check()', 300000)
          }
      }

      function login() {
        $.post(ENDPOINT,
          JSON.stringify({method: 'auth.login', params: ['deluge'], id: '2'}),
          function(obj, status) {
            // Was the login successful? If so, do the connection check.
            // Otherwise, do nothing - we need to be logged in for the ext to work.
            if(obj && obj['result']) {
              console.log('deluge: logged in successfully')
              check_connection()
              return
            }
            console.log('deluge: failed to login to the webUI :(')
          }, 'json')
      }

      function check_connection() {
        console.log('deluge: checking daemon connection status.')
        $.post(ENDPOINT,
          JSON.stringify({method: 'web.connected', params: [], id: '3'}),
          function(obj, status) {
            // If the webUI is connected to the deluge daemon then lets
            // kick the plugin actions going :D.
            if(obj && obj['result']) {
              console.log('deluge: connected!')
              begin_status_check()
              return
            }
            // Otherwise, we can't do anything, we check the connection every 5 minutes so maybe it'll be back then?
            console.log('deluge: not connected to daemon, please check Deluge webUI settings. Checking again in 5 minutes!')
          }, 'json')
      }

      function begin_status_check() {
        // Enable the active icon/tooltip message.
        chrome.browserAction.setIcon({path: 'images/icons/deluge_active.png'})
        chrome.browserAction.setTitle({title: 'Deluge Torrent status information'})
      }

      $(document).ready(deluge_status_check)
    </script>

  </head>
  <body>
  </body>
</html>